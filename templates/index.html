<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkyMap Checkpoint Control - Quality Assessment Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body>
    <!-- Header with SkyMap Logo -->
    <header class="bg-primary text-white py-3">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="d-flex align-items-center">
                        <img src="{{ url_for('static', filename='images/skymap_logo.bmp') }}" alt="SkyMap Logo" class="me-3" style="height: 60px;">
                        <div>
                            <h1 class="h3 mb-0">Checkpoint Control</h1>
                            <p class="mb-0 text-light">Quality Assessment Tool</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 text-end">
                    <p class="mb-0"><i class="fas fa-map-marker-alt me-2"></i>Professional Surveying Solutions</p>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container my-4">
        <!-- File Upload Section -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h2 class="h5 mb-0"><i class="fas fa-upload me-2"></i>File Upload</h2>
            </div>
            <div class="card-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="point_cloud" class="form-label">
                                <i class="fas fa-cloud me-2"></i>Point Cloud File
                            </label>
                            <input type="file" class="form-control" id="point_cloud" name="point_cloud" 
                                   accept=".las,.laz,.csv,.tsv,.txt" required>
                            <div class="form-text">Supported formats: LAS, LAZ, CSV, TSV, TXT</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="checkpoints" class="form-label">
                                <i class="fas fa-map-pin me-2"></i>Checkpoints File
                            </label>
                            <input type="file" class="form-control" id="checkpoints" name="checkpoints" 
                                   accept=".csv,.tsv,.txt" required>
                            <div class="form-text">CSV format with columns: id;E;N;H</div>
                        </div>
                    </div>
                    
                    <!-- CSV Format Options -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label for="cps_sep" class="form-label">CSV Separator</label>
                            <select class="form-select" id="cps_sep" name="cps_sep">
                                <option value=";">Semicolon (;)</option>
                                <option value=",">Comma (,)</option>
                                <option value="\t">Tab</option>
                                <option value=" ">Space</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="decimal" class="form-label">Decimal Separator</label>
                            <select class="form-select" id="decimal" name="decimal">
                                <option value=",">Comma (,)</option>
                                <option value=".">Period (.)</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Parameters Configuration -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h2 class="h5 mb-0"><i class="fas fa-cogs me-2"></i>Analysis Parameters</h2>
            </div>
            <div class="card-body">
                <form id="paramsForm">
                    <!-- Neighborhood Selection -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2">Neighborhood Selection</h6>
                        </div>
                        <div class="col-md-3">
                            <label for="radius" class="form-label">Fixed Radius (m)</label>
                            <input type="number" class="form-control" id="radius" name="radius" 
                                   step="0.01" min="0" placeholder="Leave empty for kNN">
                        </div>
                        <div class="col-md-3">
                            <label for="knn" class="form-label">k-Nearest Neighbors</label>
                            <input type="number" class="form-control" id="knn" name="knn" 
                                   value="200" min="1" max="1000" step="1">
                        </div>
                        <div class="col-md-6">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="adaptive_radius" name="adaptive_radius">
                                <label class="form-check-label" for="adaptive_radius">
                                    Enable Adaptive Radius
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Adaptive Radius Parameters -->
                    <div class="row mb-4" id="adaptiveRadiusParams" style="display: none;">
                        <div class="col-12">
                            <h6 class="text-secondary border-bottom pb-2">Adaptive Radius Settings</h6>
                        </div>
                        <div class="col-md-3">
                            <label for="adaptive_radius_start" class="form-label">Start Radius (m)</label>
                            <input type="number" class="form-control" id="adaptive_radius_start" name="adaptive_radius_start" 
                                   value="0.15" step="0.01" min="0">
                        </div>
                        <div class="col-md-3">
                            <label for="adaptive_radius_step" class="form-label">Step Size (m)</label>
                            <input type="number" class="form-control" id="adaptive_radius_step" name="adaptive_radius_step" 
                                   value="0.05" step="0.01" min="0">
                        </div>
                        <div class="col-md-3">
                            <label for="adaptive_radius_max" class="form-label">Max Radius (m)</label>
                            <input type="number" class="form-control" id="adaptive_radius_max" name="adaptive_radius_max" 
                                   value="0.40" step="0.01" min="0">
                        </div>
                    </div>

                    <!-- Robust Filtering -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2">Robust Filtering</h6>
                        </div>
                        <div class="col-md-3">
                            <label for="mad_alpha" class="form-label">MAD Alpha</label>
                            <input type="number" class="form-control" id="mad_alpha" name="mad_alpha" 
                                   value="6.0" step="0.1" min="0">
                            <div class="form-text">Outlier threshold</div>
                        </div>
                        <div class="col-md-3">
                            <label for="ransac_thresh" class="form-label">RANSAC Threshold (m)</label>
                            <input type="number" class="form-control" id="ransac_thresh" name="ransac_thresh" 
                                   value="0.08" step="0.01" min="0">
                            <div class="form-text">Plane fitting tolerance</div>
                        </div>
                        <div class="col-md-3">
                            <label for="ransac_iters" class="form-label">RANSAC Iterations</label>
                            <input type="number" class="form-control" id="ransac_iters" name="ransac_iters" 
                                   value="400" min="100" max="1000" step="1">
                        </div>
                        <div class="col-md-3">
                            <label for="min_inliers" class="form-label">Min Inliers</label>
                            <input type="number" class="form-control" id="min_inliers" name="min_inliers" 
                                   value="5" min="3" max="100" step="1">
                        </div>
                    </div>

                    <!-- Quality Thresholds -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2">Quality Thresholds</h6>
                        </div>
                        <div class="col-md-3">
                            <label for="min_neighbors" class="form-label">Min Neighbors</label>
                            <input type="number" class="form-control" id="min_neighbors" name="min_neighbors" 
                                   value="5" min="1" max="100" step="1">
                        </div>
                        <div class="col-md-3">
                            <label for="tolerance" class="form-label">Height Tolerance (m)</label>
                            <input type="number" class="form-control" id="tolerance" name="tolerance" 
                                   value="0.025" step="0.001" min="0">
                            <div class="form-text">Acceptable dZ deviation</div>
                        </div>
                        <div class="col-md-3">
                            <label for="centroid_max_offset" class="form-label">Centroid Max Offset (m)</label>
                            <input type="number" class="form-control" id="centroid_max_offset" name="centroid_max_offset" 
                                   value="0.15" step="0.01" min="0">
                        </div>
                    </div>

                    <!-- Selection Filters -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2">Selection Filters</h6>
                        </div>
                        <div class="col-md-3">
                            <label for="xy_maxdist" class="form-label">Max XY Distance (m)</label>
                            <input type="number" class="form-control" id="xy_maxdist" name="xy_maxdist" 
                                   step="0.01" min="0" placeholder="No limit">
                        </div>
                        <div class="col-md-3">
                            <label for="z_window" class="form-label">Z Window (m)</label>
                            <input type="number" class="form-control" id="z_window" name="z_window" 
                                   step="0.01" min="0" placeholder="No limit">
                        </div>
                    </div>

                    <!-- LAS Filters -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2">LAS/LAZ Filters</h6>
                        </div>
                        <div class="col-md-3">
                            <label for="las_keep_class" class="form-label">Keep Classes</label>
                            <input type="text" class="form-control" id="las_keep_class" name="las_keep_class" 
                                   placeholder="e.g., 2 for ground">
                            <div class="form-text">Comma-separated</div>
                        </div>
                        <div class="col-md-3">
                            <label for="las_keep_returns" class="form-label">Keep Returns</label>
                            <input type="text" class="form-control" id="las_keep_returns" name="las_keep_returns" 
                                   placeholder="e.g., 1,2">
                            <div class="form-text">Comma-separated</div>
                        </div>
                    </div>

                    <!-- Export Options -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2">Export Options</h6>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="export_points" name="export_points">
                                <label class="form-check-label" for="export_points">
                                    Export Point Cloud Points
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="export_stage" class="form-label">Export Stage</label>
                            <select class="form-select" id="export_stage" name="export_stage">
                                <option value="inliers">Inliers Only</option>
                                <option value="neighbors">All Neighbors</option>
                                <option value="after_mad">After MAD Filtering</option>
                                <option value="all">All Stages</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Submit Button -->
        <div class="text-center mb-4">
            <button type="button" class="btn btn-primary btn-lg" id="runAnalysis">
                <i class="fas fa-play me-2"></i>Run Analysis
            </button>
        </div>

        <!-- Progress and Results -->
        <div id="progressSection" style="display: none;">
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5>Processing Analysis...</h5>
                    <p class="text-muted">This may take several minutes depending on file size and parameters.</p>
                </div>
            </div>
        </div>

        <div id="resultsSection" style="display: none;">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h3 class="h5 mb-0"><i class="fas fa-check-circle me-2"></i>Analysis Complete!</h3>
                </div>
                <div class="card-body">
                    <div id="resultsContent"></div>
                </div>
            </div>
        </div>

        <!-- Error Display -->
        <div id="errorSection" style="display: none;">
            <div class="card shadow-sm border-danger">
                <div class="card-header bg-danger text-white">
                    <h3 class="h5 mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Error</h3>
                </div>
                <div class="card-body">
                    <div id="errorContent"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-dark text-light py-3 mt-5">
        <div class="container text-center">
            <p class="mb-0">&copy; 2025 SkyMap Innovations. Professional surveying solutions.</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>
